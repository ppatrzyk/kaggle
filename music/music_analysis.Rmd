---
title: "Music Production Across the World"
author: "Piotr Patrzyk"
output: 
  html_document:
    keep_md: true
---

## Introduction

An exploratory analysis of data on the popularity of musical artists. Where do the most polular artists come from? Which musical genres are the most popular? Are musical genres tied to specific countries? These are the questions investigated in this kernel.

First I read and prepare the data. This includes:

- cleaning duplicates in artists,
- establishing country of origin,
- establishing single genre from tags.

```{r dataload, echo=FALSE}
library(data.table)
library(ggplot2)
library(leaflet)
library(geojsonio)

lfm <- fread('artists.csv', encoding = 'UTF-8', na.strings = '')
```

Due to the fact that last.fm does dot disambiguate between different artists that have the same name (see dataset description), dataset contains some artists with duplicated listeners/scrobbles count, coming from the aggregate profile. For example:

```{r}
lfm[
  artist_lastfm == 'Phoenix', 
  .(artist_mb, artist_lastfm, country_mb, country_lastfm, listeners_lastfm, scrobbles_lastfm)
]
```

I collapse ambiguous artists (`ambiguous_artist == TRUE`) into one row per artist name.

```{r collapseartists, echo=TRUE}
lfm[, mbid := NULL]
fix <- lfm[ambiguous_artist == TRUE, ]
lfm <- lfm[ambiguous_artist == FALSE, ]

fix <- fix[,
  .(
    artist_mb = paste(unique(na.omit(artist_mb)), collapse = '; '),
    country_mb = paste(unique(na.omit(country_mb)), collapse = '; '),
    country_lastfm = paste(unique(na.omit(country_lastfm)), collapse = '; '),
    tags_mb = paste(na.omit(tags_mb), collapse = '; '),
    tags_lastfm = paste(unique(na.omit(tags_lastfm)), collapse = '; '),
    listeners_lastfm = max(listeners_lastfm, na.rm = TRUE),
    scrobbles_lastfm = max(scrobbles_lastfm, na.rm = TRUE),
    ambiguous_artist = TRUE
  ),
  by = artist_lastfm
]

lfm <- rbindlist(list(lfm, fix), fill = TRUE)
rm(fix)
```

Next I identify single country an artist comes from. The dataset contains conflicting information about artists' origin. Sometimes there is a legitimate ambiguity in what should be chosen, in other cases there is an incorrect information due to factual errors or artist duplicites. In either case, these need to be unified. Examples of problematic data:

```{r countryexample, echo=TRUE}
lfm[
  artist_lastfm %in% c('Rihanna', 'System of a Down', 'Shakira'),
  .(artist_mb, country_mb, country_lastfm, listeners_lastfm)
]
```

The approach is the following:

- if there is only one MusicBrainz country and it is contained in last.fm tags, this one is chosen,
- else if there is only one country in last.fm tags, this one is chosen,
- else if there is only one country in MusicBrainz tags, this one is chosen.

```{r countryfix, echo=TRUE}
# unify countries
lfm[, country := NA_character_]
lfm[
  !grepl(';', country_mb) & (mapply(grepl, country_mb, country_lastfm) | is.na(country_lastfm)),
  country := country_mb
]
lfm[
  is.na(country) & !grepl(';', country_lastfm),
  country := country_lastfm
]
lfm[
  is.na(country) & !grepl(';', country_mb),
  country := country_mb
]

#TODO last step by first match in lastfm tags

```


## Popularity distribution

very few artists generate the majority of world's scrobbles, while the vast majority of artists have a very small number of listeners and scrobbles.
